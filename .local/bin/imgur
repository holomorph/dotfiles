#!/bin/bash

# imgur v4 by Bart Nagel <bart@tremby.net>
#
# Required: curl
# Optional: xclip

# API Key provided by Alan@imgur.com
apikey="b3625162d3418ac51a9ee805b1840452"

die() {
    printf >&2 "imgur: %s\n" "$@"
    exit 1
}

# check argument
if [[ $# -eq 0 ]]; then
    die "no file specified"
elif [[ "$1" = "-h" || "$1" = "--help" ]]; then
    printf 'Usage: %s <file>\n' "${0##*/}"
    exit 0
fi

print_tag() {
    local input="$1"
    local regex="<$2>(.*)</$2>"

    # parse input for regex contents
    if [[ $input =~ $regex ]]; then
        printf "%s" "${BASH_REMATCH[1]}"
        return 0
    fi
    return 1
}

handle_response() {
    local response="$1"
    local err url del

    # check for errors from imgur
    if err=$(print_tag "$response" 'error_msg'); then
        die "response: $err"
    fi

    # print direct image link
    if url=$(print_tag "$response" 'original_image'); then
        printf "url: %s\n" "$url"
    fi

    # print deletion link
    if del=$(print_tag "$response" 'delete_page'); then
        printf "del: %s\n" "$del" >&2
    fi

    # try putting the url on the clipboard
    if [[ -n $DISPLAY ]] && type -p xclip >/dev/null; then
        printf "%s" "$url" | xclip;
    fi
}

upload_image() {
    local file="$1"

    if [[ ! -f "$file" ]]; then
        die "skipping ‘$file’: No such file"
    fi

    # upload the image
    response="$(curl -F "key=$apikey" -F "image=@$file" \
        http://imgur.com/api/upload.xml 2>/dev/null)"

    # die if curl errors
    if (( $? != 0 )); then
        die "upload ‘$file’ failed"
    fi

    handle_response "$response"
}

# main
upload_image "$1"
